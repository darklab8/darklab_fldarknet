name: Deploy docker production

on:
    workflow_dispatch:
    push:
        tags:
            - "*"

env:
  DOCKER_HOST: ssh://root@darkbot
        
jobs:
  build:
    name: Run the CI suite
    uses: darklab8/fl-darkstat/.github/workflows/deploy-docker-staging.yml@master
    secrets: inherit
  deploy:
    runs-on: ubuntu-22.04
    needs:
      - build
    steps:
      - name: Checkout git repo with tags and commits for autogit
        uses: actions/checkout@v3

      - name: Install Taskfile
        uses: darklab8/infra/.github/actions/install-taskfile@master

      - name: Set up Go
        uses: darklab8/infra/.github/actions/install-go@master

      # SOURCE_NAME: The branch or the tag
      # SOURCE_BRANCH: The branch or empty
      # SOURCE_TAG: The tag or empty
      - name: Find tags
        id: data
        run: |
          echo "BUILD_VERSION=${GITHUB_REF#refs/*/}" >> $GITHUB_OUTPUT

      - name: Echo tags
        run: |
          echo ${{ steps.data.outputs.BUILD_VERSION }}
      
      - name: Docker login
        run: echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login --username darkwind8 --password-stdin

      - name: Install ssh key
        run: |
          mkdir ~/.ssh | true
          echo "${{ secrets.SSH_KEY_BASE64 }}" | base64 --decode > ~/.ssh/id_rsa
          echo "Host darkbot" > ~/.ssh/config
          echo "    HostName 37.27.207.42" >> ~/.ssh/config
          echo "    User root" >> ~/.ssh/config
          echo "    IdentityFile ~/.ssh/id_rsa" >> ~/.ssh/config
          echo "    IdentitiesOnly yes" >> ~/.ssh/config
          chmod 700 ~/.ssh
          chmod 600 ~/.ssh/*
          ssh-keyscan -H 37.27.207.42 >> ~/.ssh/known_hosts | true
          ssh-keyscan -H darkbot >> ~/.ssh/known_hosts | true

      - name: Push image
        run: |
          docker pull darkwind8/darkstat:latest
          docker tag darkwind8/darkstat:latest darkwind8/darkstat:${{ steps.data.outputs.BUILD_VERSION }}
          docker tag darkwind8/darkstat:latest darkwind8/darkstat:production
          docker push darkwind8/darkstat:${{ steps.data.outputs.BUILD_VERSION }}
          docker push darkwind8/darkstat:production
          
      - name: Switch service image to new one
        run: |
          docker pull darkwind8/darkstat:production && docker service update --image darkwind8/darkstat:production darkstat-production
